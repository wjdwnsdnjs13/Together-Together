<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.together.springStudy.mapper.ClubMapper">

    <resultMap id="ClubDataMap" type="com.together.springStudy.model.ClubData">
        <id column="club_id" property="clubId"/>
        <result column="club_leader_id" property="clubLeaderId"/>
        <result column="club_board_id" property="clubBoardId"/>
        <result column="club_name" property="clubName"/>
        <result column="club_description" property="clubDescription"/>
    </resultMap>

    <resultMap id="ClubJoinQueueMap" type="com.together.springStudy.model.ClubJoinQueue">
        <id column="join_queue_id" property="joinQueueId"/>
        <result column="join_user_id" property="joinUserId"/>
        <result column="join_club_id" property="joinClubId"/>
        <result column="join_content" property="joinContent"/>
    </resultMap>

    <resultMap id="ClubMemberDataMap" type="com.together.springStudy.model.ClubMemberData">
        <id column="user_nickname" property="userNickname"/>
    </resultMap>

    <select id="getAllClub" resultMap="ClubDataMap">
        SELECT
            *
        FROM
            club_data
    </select>
    <select id="getClubByPrimaryKey" resultType="com.together.springStudy.model.ClubData">
        SELECT
            *
        FROM
            club_data
        WHERE
            club_id = #{clubId}
    </select>

    <select id="getJoinClubQueue" resultMap="ClubJoinQueueMap">
        SELECT
            *
        FROM
            club_join_queue
        WHERE
            join_club_id = #{clubId}
    </select>

    <select id="getClubMemberByClubId" resultMap="ClubMemberDataMap">
        SELECT
            user_data.user_nickname
        FROM
            club_member
        INNER JOIN
            user_data ON
            club_member.member_user_id = user_data.user_id
        WHERE
            club_member.member_club_id = #{clubId}
        ORDER BY
            user_data.user_name;
    </select>

    <select id="getClubForKeyword" parameterType="com.together.springStudy.model.Keyword" resultMap="ClubDataMap">
        SELECT
            *
        FROM
            club_data
        <where>
            <if test="keyword != null">
                club_name like concat('%', #{keyword}, '%')
                OR
                club_description like concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <insert id="createClub" parameterType="com.together.springStudy.model.ClubData">
        <selectKey resultType="int" keyProperty="clubId" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO
            club_data
            (club_leader_id, club_name, club_description)
        VALUES
            (#{clubLeaderId}, #{clubName}, #{clubDescription})
    </insert>
    <insert id="createClubMaster" parameterType="com.together.springStudy.model.ClubMember">
        INSERT INTO
            club_member
            (member_user_id, member_club_id, member_permission)
        VALUES
            (#{memberUserId}, #{memberClubId}, #{memberPermission})
    </insert>

    <insert id="joinClub" parameterType="com.together.springStudy.model.ClubJoinQueue">
        INSERT INTO
            club_join_queue
            (join_user_id, join_club_id)
        VALUES
            (#{joinUserId}, #{joinClubId})
    </insert>
    
    <insert id="joinClubApproval" parameterType="com.together.springStudy.model.ClubJoinQueue">
        INSERT INTO
            club_member
            (member_user_id, member_club_id)
        VALUES
            (#{joinUserId}, #{joinClubId})
    </insert>
    <delete id="deleteJoinClub">
        DELETE FROM
            club_join_queue
        WHERE
            join_queue_id = #{joinQueueId}
    </delete>

    <update id="updateClubRecruiting" parameterType="com.together.springStudy.model.ClubData">
        UPDATE
            club_data
        SET
            club_recruiting = #{clubRecruiting}
        WHERE
            club_id = #{clubId}
    </update>
    
    <select id="getAffiliatedClub" resultMap="ClubDataMap">
        SELECT
            club_data.*
        FROM
            club_data
        INNER JOIN
            club_member ON
            club_data.club_id = club_member.member_club_id
        WHERE
            club_member.member_user_id = #{userId}
    </select>
    
<!--    <insert id="joinClub" parameterType="com.together.springStudy.model.ClubJoinQueue">-->
<!--        INSERT INTO-->
<!--            club_join_queue-->
<!--            (join_user_id, join_club_id, join_content)-->
<!--        VALUES-->
<!--            (#{joinUserId, #{joinClubId}, #{joinContent})-->
<!--    </insert>-->

</mapper>